!function(e,t){"function"==typeof define&&define.amd?define([],t):e.JSO=t()}(this,function(){var e,t,n;return function(o){function r(e,t){return w.call(e,t)}function i(e,t){var n,o,r,i,s,a,u,c,f,l,p,g=t&&t.split("/"),h=k.map,d=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(g=g.slice(0,g.length-1),e=e.split("/"),s=e.length-1,k.nodeIdCompat&&S.test(e[s])&&(e[s]=e[s].replace(S,"")),e=g.concat(e),f=0;f<e.length;f+=1)if(p=e[f],"."===p)e.splice(f,1),f-=1;else if(".."===p){if(1===f&&(".."===e[2]||".."===e[0]))break;f>0&&(e.splice(f-1,2),f-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((g||d)&&h){for(n=e.split("/"),f=n.length;f>0;f-=1){if(o=n.slice(0,f).join("/"),g)for(l=g.length;l>0;l-=1)if(r=h[g.slice(0,l).join("/")],r&&(r=r[o])){i=r,a=f;break}if(i)break;!u&&d&&d[o]&&(u=d[o],c=f)}!i&&u&&(i=u,a=c),i&&(n.splice(0,a,i),e=n.join("/"))}return e}function s(e,t){return function(){return g.apply(o,m.call(arguments,0).concat([e,t]))}}function a(e){return function(t){return i(t,e)}}function u(e){return function(t){x[e]=t}}function c(e){if(r(v,e)){var t=v[e];delete v[e],y[e]=!0,p.apply(o,t)}if(!r(x,e)&&!r(y,e))throw new Error("No "+e);return x[e]}function f(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function l(e){return function(){return k&&k.config&&k.config[e]||{}}}var p,g,h,d,x={},v={},k={},y={},w=Object.prototype.hasOwnProperty,m=[].slice,S=/\.js$/;h=function(e,t){var n,o=f(e),r=o[0];return e=o[1],r&&(r=i(r,t),n=c(r)),r?e=n&&n.normalize?n.normalize(e,a(t)):i(e,t):(e=i(e,t),o=f(e),r=o[0],e=o[1],r&&(n=c(r))),{f:r?r+"!"+e:e,n:e,pr:r,p:n}},d={require:function(e){return s(e)},exports:function(e){var t=x[e];return"undefined"!=typeof t?t:x[e]={}},module:function(e){return{id:e,uri:"",exports:x[e],config:l(e)}}},p=function(e,t,n,i){var a,f,l,p,g,k,w=[],m=typeof n;if(i=i||e,"undefined"===m||"function"===m){for(t=!t.length&&n.length?["require","exports","module"]:t,g=0;g<t.length;g+=1)if(p=h(t[g],i),f=p.f,"require"===f)w[g]=d.require(e);else if("exports"===f)w[g]=d.exports(e),k=!0;else if("module"===f)a=w[g]=d.module(e);else if(r(x,f)||r(v,f)||r(y,f))w[g]=c(f);else{if(!p.p)throw new Error(e+" missing "+f);p.p.load(p.n,s(i,!0),u(f),{}),w[g]=x[f]}l=n?n.apply(x[e],w):void 0,e&&(a&&a.exports!==o&&a.exports!==x[e]?x[e]=a.exports:l===o&&k||(x[e]=l))}else e&&(x[e]=n)},e=t=g=function(e,t,n,r,i){if("string"==typeof e)return d[e]?d[e](t):c(h(e,t).f);if(!e.splice){if(k=e,k.deps&&g(k.deps,k.callback),!t)return;t.splice?(e=t,t=n,n=null):e=o}return t=t||function(){},"function"==typeof n&&(n=r,r=i),r?p(o,e,t,n):setTimeout(function(){p(o,e,t,n)},4),g},g.config=function(e){return g(e)},e._defined=x,n=function(e,t,n){t.splice||(n=t,t=[]),r(x,e)||r(v,e)||(v[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("utils",["require","exports","module"],function(){var e={};return e.epoch=function(){return Math.round((new Date).getTime()/1e3)},e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},e.parseQueryString=function(e){for(var t,n=/\+/g,o=/([^&;=]+)=?([^&;]*)/g,r=function(e){return decodeURIComponent(e.replace(n," "))},i=e,s={};t=o.exec(i);)s[r(t[1])]=r(t[2]);return s},e.scopeList=function(t){return e.uniqueList(t).join(" ")},e.uniqueList=function(e){for(var t={},n=[],o=0;o<e.length;o++)t[e[o]]=1;for(var r in t)t.hasOwnProperty(r)&&n.push(r);return n},e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},e.log=function(e){console&&console.log&&console.log(arguments.length>1?arguments:e)},e.encodeURL=function(e,t){var n,o=e,r=0,i=-1===e.indexOf("?")?"?":"&";for(n in t)o+=(0===r++?i:"&")+encodeURIComponent(n)+"="+encodeURIComponent(t[n]);return o},e.epoch=function(){return Math.round((new Date).getTime()/1e3)},e}),n("store",["require","exports","module","./utils"],function(e){var t=e("./utils"),n={};n.saveState=function(e,t){localStorage.setItem("state-"+e,JSON.stringify(t))},n.getState=function(e){var t=JSON.parse(localStorage.getItem("state-"+e));return localStorage.removeItem("state-"+e),t};var o=function(e){console&&console.log&&console.log(arguments.length>1?arguments:e)};return n.hasScope=function(e,t){var n;if(!e.scopes)return!1;for(n=0;n<e.scopes.length;n++)if(e.scopes[n]===t)return!0;return!1},n.filterTokens=function(e,o){var r,i,s,a=[],u=t.epoch();for(o||(o=[]),r=0;r<e.length;r++){for(s=!0,e[r].expires&&e[r].expires<u+1&&(s=!1),i=0;i<o.length;i++)n.hasScope(e[r],o[i])||(s=!1);s&&a.push(e[r])}return a},n.saveTokens=function(e,t){localStorage.setItem("tokens-"+e,JSON.stringify(t))},n.getTokens=function(e){var t=JSON.parse(localStorage.getItem("tokens-"+e));return t||(t=[]),o("Token received",t),t},n.wipeTokens=function(e){localStorage.removeItem("tokens-"+e)},n.saveToken=function(e,t){var o=this.getTokens(e);o=n.filterTokens(o),o.push(t),this.saveTokens(e,o)},n.getToken=function(e,t){var o=this.getTokens(e);return o=n.filterTokens(o,t),o.length<1?null:o[0]},n}),n("Config",[],function(){var e=function(e){for(var t=1;t<e.length;t++)for(var n in e[t])e[t].hasOwnProperty(n)&&(e[0][n]=e[t][n]);return e[0]},t=function(){for(var t=[{}],n=0;n<arguments.length;n++)t.push(arguments[n]);this.config=e(t)};return t.prototype.has=function(e){var t=this.config,n=e.split("."),o=0;for(o=0;o<n.length;o++){if(!t.hasOwnProperty(n[o]))return!1;t=t[n[o]]}return!0},t.prototype.get=function(e,t,n){n=n||!1;var o=this.config,r=e.split("."),i=0;for(i=0;i<r.length;i++){if(!o.hasOwnProperty(r[i])){o=void 0;break}o=o[r[i]]}if("undefined"==typeof o){if(n)throw new Error("Configuration option ["+r[i]+"] required but not provided.");return t}return o},t}),n("jso",["require","exports","module","./store","./utils","./Config"],function(e){var t={lifetime:3600,debug:!0,foo:{bar:"lsdkjf"}},n=e("./store"),o=e("./utils"),r=e("./Config"),i=function(e){this.config=new r(t,e),this.providerID=this.getProviderID(),i.instances[this.providerID]=this,this.callbacks={},this.callbacks.redirect=i.redirect};return i.internalStates=[],i.instances={},i.store=n,i.enablejQuery=function(e){i.$=e},i.redirect=function(e){window.location=e},i.prototype.inappbrowser=function(e){var t=this;return function(n,r){var i=function(e){return function(n){var i=n.url;o.log("loadstop event triggered, and the url is now "+i),t.URLcontainsToken(i)&&(setTimeout(function(){e.close()},500),t.callback(i,function(){o.log("Closing window ",e),"function"==typeof r&&r()}))}},s="_blank";e.hasOwnProperty("target")&&(s=e.target);var a={};o.log("About to open url "+n);var u=window.open(n,s,a);o.log("URL Loaded... "),u.addEventListener("loadstart",i(u)),o.log("Event listeren ardded... ",u)}},i.prototype.on=function(e,t){if("string"!=typeof e)throw new Error("Registering triggers on JSO must be identified with an event id");if("function"!=typeof t)throw new Error("Registering a callback on JSO must be a function.");this.callbacks[e]=t},i.prototype.getProviderID=function(){var e=this.config.get("providerID",null);if(null!==e)return e;var t=this.config.get("client_id",null,!0),n=this.config.get("authorization",null,!0);return n+"|"+t},i.prototype.URLcontainsToken=function(e){if(e){if(-1===e.indexOf("#"))return!1;h=e.substring(e.indexOf("#"))}return h.length<2?!1:-1===h.indexOf("access_token")?!1:!0},i.prototype.callback=function(e,t,r){var s,a,u,c=window.location.hash,f=o.epoch();if(o.log("JSO.prototype.callback() "+e+" callback="+typeof t),e){if(-1===e.indexOf("#"))return;c=e.substring(e.indexOf("#"))}if(!(c.length<2)&&-1!==c.indexOf("access_token")){if(c=c.substring(1),s=o.parseQueryString(c),s.state)a=n.getState(s.state);else{if(!r)throw"Could not get [state] and no default providerid is provided.";a={providerID:r}}if(!a)throw"Could not retrieve state";if(!a.providerID)throw"Could not get providerid from state";if(!i.instances[a.providerID])throw"Could not retrieve JSO.instances for this provider.";u=i.instances[a.providerID],!s.state&&co.scope&&(a.scopes=u._getRequestScopes(),o.log("Setting state: ",a)),o.log("Checking atoken ",s," and instance ",u),s.expires_in?s.expires=f+parseInt(s.expires_in,10):u.config.get("default_lifetime",null)===!1||(u.config.has("permanent_scope")?n.hasScope(s,u.config.get("permanent_scope"))||(s.expires=f+15768e4):s.expires=u.config.has("default_lifetime")?f+u.config.get("default_lifetime"):f+3600),s.scope?s.scopes=s.scope.split(" "):a.scopes&&(s.scopes=a.scopes),n.saveToken(a.providerID,s),window.location.hash=a.restoreHash?a.restoreHash:"",o.log(s),o.log("Looking up internalStates storage for a stored callback... ","state="+s.state,i.internalStates),i.internalStates[s.state]&&"function"==typeof i.internalStates[s.state]&&(o.log("InternalState is set, calling it now!"),i.internalStates[s.state](s),delete i.internalStates[s.state]),o.log("Successfully obtain a token, now call the callback, and may be the window closes",t),"function"==typeof t&&t(s)}},i.prototype.dump=function(){var e="",t=n.getTokens(this.providerID);return e+="Tokens: \n"+JSON.stringify(t,void 0,4)+"\n\n",e+="Config: \n"+JSON.stringify(this.config,void 0,4)+"\n\n"},i.prototype._getRequestScopes=function(e){var t,n=[];if(this.config.scopes&&this.config.scopes.request)for(t=0;t<this.config.scopes.request.length;t++)n.push(this.config.scopes.request[t]);if(e&&e.scopes&&e.scopes.request)for(t=0;t<e.scopes.request.length;t++)n.push(e.scopes.request[t]);return o.uniqueList(n)},i.prototype._getRequiredScopes=function(e){var t,n=[];if(this.config.scopes&&this.config.scopes.require)for(t=0;t<this.config.scopes.require.length;t++)n.push(this.config.scopes.require[t]);if(e&&e.scopes&&e.scopes.require)for(t=0;t<e.scopes.require.length;t++)n.push(e.scopes.require[t]);return o.uniqueList(n)},i.prototype.getToken=function(e,t){var o=this._getRequiredScopes(t),r=n.getToken(this.providerID,o);return r?e(r):void this._authorize(e,t)},i.prototype.checkToken=function(e){var t=this._getRequiredScopes(e);return n.getToken(this.providerID,t)},i.prototype._authorize=function(e,t){var r,s,a,u=this.config.get("authorization",null,!0),c=this.config.get("client_id",null,!0);o.log("About to send an authorization request to this entry:",u),o.log("Options",t,"callback",e),r={response_type:"token",state:o.uuid()},e&&"function"==typeof e&&(o.log("About to store a callback for later with state="+r.state,e),i.internalStates[r.state]=e),this.config.has("redirect_uri")&&(r.redirect_uri=this.config.get("redirect_uri","")),r.client_id=c,a=this._getRequestScopes(t),a.length>0&&(r.scope=o.scopeList(a)),o.log("DEBUG REQUEST"),o.log(r),s=o.encodeURL(u,r),window.location.hash&&(r.restoreHash=window.location.hash),r.providerID=this.providerID,a&&(r.scopes=a),o.log("Saving state ["+r.state+"]"),o.log(JSON.parse(JSON.stringify(r))),n.saveState(r.state,r),this.gotoAuthorizeURL(s,e)},i.prototype.gotoAuthorizeURL=function(e,t){if(!this.callbacks.redirect||"function"!=typeof this.callbacks.redirect)throw new Error("Cannot redirect to authorization endpoint because of missing redirect handler");this.callbacks.redirect(e,t)},i.prototype.wipeTokens=function(){n.wipeTokens(this.providerID)},i.prototype.ajax=function(e){var t,n=this;if(!i.hasOwnProperty("$"))throw new Error("JQuery support not enabled.");oauthOptions=e.oauth||{};var r=e.error||null;return e.error=function(e,i,s){o.log("error(jqXHR, textStatus, errorThrown)"),o.log(e),o.log(i),o.log(s),401===e.status&&(o.log("Token expired. About to delete this token"),o.log(t),n.wipeTokens()),r&&"function"==typeof r&&r(e,i,s)},this.getToken(function(t){return o.log("Ready. Got an token, and ready to perform an AJAX call",t),"qs"===n.config.get("presenttoken",null)?(e.data||(e.data={}),e.data.access_token=t.access_token):(e.headers||(e.headers={}),e.headers.Authorization="Bearer "+t.access_token),o.log("$.ajax settings",e),i.$.ajax(e)},oauthOptions)},i}),t("jso")});